@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <link href="~/content/img/favicon.ico" type="image/x-icon" rel="shortcut icon" />
    <meta charset="utf-8" />
    <meta content="IE=edge, chrome=1" http-equiv="X-UA-Compatible" />
    <title>.: Ingreso :.</title>
    
    <link href="~/Content/css/bootstrap.css" rel="stylesheet" />
    <link href="~/Content/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/css/font-awesome.min.css" rel="stylesheet" />
    <link href="~/Content/css/site.css" rel="stylesheet" />
    <link href="~/Content/css/datatables.min.css" rel="stylesheet" />
    <link href="~/Content/css/bootstrap-switch.min.css" rel="stylesheet" />
    <link href="~/Content/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="~/Content/css/estilos.css" rel="stylesheet" />
    <link href="~/Content/css/responsiveslides.css" rel="stylesheet" />

    <script src="~/Scripts/jquery-1.12.1.min.js" type="text/javascript"></script>
    <script src="~/Scripts/bootstrap.js" type="text/javascript"></script>
    <script src="~/Scripts/bootstrap.min.js" type="text/javascript"></script>
    <script src="~/Scripts/login.js" type="text/javascript"></script>
    <script src="~/Scripts/responsiveslides.min.js" type="text/javascript"></script>

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->



    

    <script type="text/javascript">

        window.history.forward(1);

        //obtener url base en layout login:
        var baseUrl = '@ViewBag.BaseUrl';
        
        
        sessionStorage.setItem("userName", null);
        sessionStorage.setItem("rutUsuario", null);

        function AuthLogin() {
            $("#msg").hide();
            $("#msg").text("");
            $("#cargando").fadeIn('slow');
            if ($("#username").val() == "") {
                setTimeout(
                            function () {
                                $("#msg").fadeIn('slow');
                                $("#msg").text("* No ha indicado el usuario.");
                                $("#cargando").fadeOut('slow');

                            }, 500
                        );
                return false;
            }

            if ($("#password").val() == "") {
                setTimeout(
                            function () {
                                $("#msg").fadeIn('slow');
                                $("#msg").text("* No ha indicado la contraseña.");
                                $("#cargando").fadeOut('slow');

                            }, 500
                        );
                return false;
            }

            var data = {
                "user": $("#username").val(),
                "password": $("#password").val()
            };
            $.ajax({
                url: baseUrl + "/Auth/AuthLogin",
                type: "POST",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json",
                success: function (response) {
                    if (response.Success) {
                        //redireccionar
                        sessionStorage.setItem("userName", response.UserName);
                        sessionStorage.setItem("rutUsuario", response.RutUsuario);
                        location.href = baseUrl + '/Inicio/Index';
                        setTimeout(function () { $("#cargando").fadeOut('slow'); }, 1000);
                    } else {
                        if (response.Message == "") {
                            response.Message = "Usuario incorrecto.";
                        }
                        setTimeout(
                            function () {
                                $("#msg").fadeIn('slow');
                                if (response.Message == "Contrase?a incorrecta, comuniquese con Mesa de Atencion Tecnologica  : mat@bancoconsorcio.cl ") {

                                    $("#msg").append("Contraseña incorrecta, <br/>Favor registrar incidente en: <a style='color:red; background-color:#f2dede; width:150px;  font-family: 'Century Gothic', verdana, arial, helvetica, sans-serif;display:inline-block' href='https://banco-consorcio.atlassian.net/servicedesk/customer/portal/5/user/login'>Mesa de Atención Tecnológica</a>");


                                }
                                else {
                                    $("#msg").text("* " + response.Message);

                                }
                                
                                
                                $("#cargando").fadeOut('slow');
                            }, 2000
                        );
                    }
                },
                error: function () {
                    console.log("Error Login");
                }
            });


        }

        function pressEnter(e) {
            if (e.keyCode === 13) {
                AuthLogin();
            }

            return false;
        }

        function BotonOver() {
            $("#divBtn").removeClass("ingresar_btn");
            $("#btnLogin").removeClass("ingresar_btn");

            $("#divBtn").addClass("ingresar_btn_b");
            $("#btnLogin").addClass("ingresar_btn_b");
        }

        function BotonOut() {
            $("#divBtn").removeClass("ingresar_btn_b");
            $("#btnLogin").removeClass("ingresar_btn_b");

            $("#divBtn").addClass("ingresar_btn");
            $("#btnLogin").addClass("ingresar_btn");
        }

        function RecuperarClave() {
            //$('#recuperarClaveUsuario').appendTo("body").modal('show');
            $("#rut").val("");
            $("#usuario").val("");
            $("#email").val("");

            $("#rutError").text("");
            $('#resetError').text("");
            $("#emailError").text("");
            $("#usuarioError").text("");

            $('#recuperarClaveUsuario').modal({ backdrop: 'static', keyboard: false, show: true });
        }

        function EnvioReseteoClave() {
            var pRut = $("#rut").val();
            var pUsuario = $("#usuario").val();
            //var pEmail = $("#email").val();
            var validar = true;
            $('#resetError').text('');           

            $("#rutError").text("");
           // $("#emailError").text("");
            $("#usuarioError").text("");            

            if (pRut == "") {
                $("#rutError").text("Debe Ingresar el rut del usuario..");                
                validar = false;
            }

            if (pUsuario == "") {
                $("#usuarioError").text("Debe Ingresar el nombre del usuario..");
                validar = false;
            }

            //if (pEmail == "") {
            //    $("#emailError").text("Debe Ingresar el email del usuario..");
            //    validar = false;
            //}

            data = {
                usuario: pUsuario,
                rut: pRut
            };

            if (validar) {
                $("#ajaxLoader").show();

                $.ajax({
                    url: baseUrl + "/Auth/ReseteoClave",
                    type: "POST",
                    data: JSON.stringify(data),
                    dataType: "json",
                    contentType: "application/json",
                    success: function (response) {
                        if (response.status == "success") {
                            $('#recuperarClaveUsuario').appendTo("body").modal('hide');
                            $('#usuarioresetoclave').val(pUsuario);
                            $('#claveActual').val('');
                            $('#claveNueva').val('');
                            $('#RepiteclaveNueva').val('');
                            $("#ajaxLoader").hide();
                            $('#CambiarClaveUsuario').modal({ backdrop: 'static', keyboard: false, show: true });
                          //  $("#cargando").fadeOut('slow');                       
                        } else {
                            $('#resetError').text(response.msg);
                            $("#ajaxLoader").hide();
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        console.log("Error al reseteo del clave");
                        console.log(textStatus);
                        console.log(errorThrown);
                        $("#ajaxLoader").hide();
                        //$("#cargando").fadeOut('slow');
                    }
                });
            }
        }

        function CambioClave() {
            var pClaveActual = $("#claveActual").val();
            var pClaveNueva  = $("#claveNueva").val();
            var pRepiteClaveNueva = $("#RepiteclaveNueva").val();
            var pUsuario = $("#usuarioresetoclave").val();         

            var validar = true;

            $('#errorCambioClave').text("");
            $("#claveActualError").text("");
            $("#claveNuevaError").text("");
            $("#repiteclaveNuevaError").text("");         

            if (pClaveActual == "") {
                $("#rutError").text("Debe Ingresar el Clave enviada a su correo.");
                validar = false;
            }

            if (pClaveNueva == "") {
                $("#usuarioError").text("Debe Ingresar la clave nueva");
                validar = false;
            }

            if (pRepiteClaveNueva == "") {
                $("#emailError").text("Debe Repetir la clave nueva ingresada.");
                validar = false;
            }

            if (pClaveNueva != pRepiteClaveNueva) {
                $('#errorCambioClave').text("No coinciden las claves ingresadas");
                validar = false;
            } 

            var data = {
                sUsuario: pUsuario,
                sClave: pClaveNueva,
                sClaveActual: pClaveActual
            };

            if (validar) {
                $("#ajaxLoaderLineas").show();

                $.ajax({
                    url: baseUrl + "/Auth/CambioClave",
                    type: "POST",
                    data: JSON.stringify(data),
                    dataType: "json",
                    contentType: "application/json",
                    success: function (response) {
                        if (response.codigo == 1) {                                                       
                            $('#claveActual').val('');
                            $('#claveNueva').val('');
                            $('#RepiteclaveNueva').val('');
                            $("#ajaxLoaderLineas").hide();
                            $('#CambiarClaveUsuario').appendTo("body").modal("hide");
                            windows.href.location = baseUrl + '/Auth/Login/'                            
                        } else {
                            $('#errorCambioClave').text(response.msg);
                            $("#ajaxLoaderLineas").hide();
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $("#ajaxLoaderLineas").hide();
                        console.log("Error al reseteo del clave");
                        console.log(textStatus);
                        console.log(errorThrown);
                    }
                });
            }
            //$('#CambiarClaveUsuario').appendTo("body").modal('hide');
        }

        //setInterval(function () { cambiarFondo(); }, 3000);
    </script>  
</head>
<body id="page">
    <ul class="cb-slideshow">
        <li><span></span></li>
        <li><span></span></li>
        <li><span></span></li>
        <li><span></span></li>
        <li><span></span></li>
        <li><span></span></li>
        <li><span></span></li>
        <li><span></span></li>
    </ul>

    <div>
        @RenderBody()
        <div class="footer">
            <div class="container Contfooter_login hidden-desktop">

                <div class="col-xs-12">
                    <div class="Contfooter_izq">
                        <a href="http://www.bancoconsorcio.cl" style="margin-right: 50px;">www.bancoconsorcio.cl</a>
                    </div>
                    <div class="Contfooter_der">
                        @*<a href="#" onclick="alert('No disponible');">Recuperar Clave </a>*@
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Espere -->
    <div class="col-lg-12" id="cargando" style="display:none;">
        <div class="overlay" />
        <div class="overlayContent">
            <h2><img src="~/Content/img/spinner_squares_circle.gif" height="31" width="31" /> Espere por favor...</h2>
        </div>
    </div>
    <!-- Fin -->
</body>
</html>